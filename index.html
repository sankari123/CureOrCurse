<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
		
		<title>DIVE</title>
<script type="text/javascript" src="cordova.js"></script>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
	

<script>
		var x,y;
		var flg;
	    	var return_data;
		var locArr;
		var tmpDat1;
		var latR;
		var latR1;
		var result;
		var zoom;
		var c,ctx;
		multiArr = [];
		multiArr1 = [];
		var mnu_select=false;
		var fone;
		document.addEventListener("deviceready",onDeviceReady,false);
		//window.onload = function(){ document.getElementById("loading").style.display = "none" } 
	window.document.addEventListener('orientationchange', function() {
  var iOS = navigator.userAgent.match(/(iPad|iPhone|iPod)/g);
  var viewportmeta = document.querySelector('meta[name="viewport"]');
  if (iOS && viewportmeta) {
    if (viewportmeta.content.match(/width=device-width/)) {
      viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=1');
    }
    viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=' + window.innerWidth);
  }
  // If you want to hide the address bar on orientation change, uncomment the next line
  // window.scrollTo(0, 0);
}, false);
	
		function onDeviceReady()
		{
		document.addEventListener("backbutton", function (e) {
        	e.preventDefault(); 
		navigator.notification.confirm("Do you want to exit DIVE?", onConfirmExit, "DIVE", "Yes,No");    }, false );
		}
	
		function onConfirmExit(button) {
		if(button==2){ //If User select a No, then return back;
        	return;
		}else{
    		if (navigator.app) {
            	navigator.app.exitApp();
        	}
        	else if (navigator.device) {
            	navigator.device.exitApp();
        	}
       // navigator.app.exitApp(); // If user select a Yes, quit from the app.
		}
		}
	   
function ajaxCall(passVar) {
	document.getElementById("map").style.display="block";
	document.getElementById("map").style.visibility=true;
	document.getElementById("lst_mnu").style.display="none";
	document.getElementById("lst_mnu").style.visibility=false;
	document.getElementById("sms").style.display="none";
	document.getElementById("sms").style.visibility="false";
	document.getElementById("inTab").style.display="none";
	document.getElementById("inTab").style.visibility="false";
	
		    if(passVar=='true')
			{
			mnu_select=true;
			}
			else
			{
			mnu_select=false;
			}
				
			zoom=14;
		var params = "lat1=" + x +"&long11=" + y; 
		var myURL="http://www.writeacademy.in/dive/passVar1.php"; 
        var request = new XMLHttpRequest(); 
        request.open("POST", myURL, true); 
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); 
        request.setRequestHeader("Content-length", params.length); 
        request.setRequestHeader("Connection", "close"); 
        request.onreadystatechange = function() {//Call a function when the state changes. 
                if(request.readyState == 4 && request.status == 200) { 
                     //   alert("response: "+request.responseText);
			document.getElementById("ajaxDiv").innerHTML = request.responseText;
			document.getElementById('rest1').value=request.responseText;
			procVal();
                } 
        } 
        request.send(params); 
}
	
	
	
function getLoc()
{
		if (navigator.geolocation)
          {
            navigator.geolocation.getCurrentPosition(myMap);
          }
        else
          {
             alert("Geolocation API not supported.");
          }
	}
function myMap(position) {
       x = position.coords.latitude;
        y = position.coords.longitude;
		alert(x);
  var myCenter = new google.maps.LatLng(x,y);
	document.getElementById("map").width=window.innerWidth;
	document.getElementById("map").height=window.innerHeight;
  var mapCanvas = document.getElementById("map");
  var mapOptions = {center: myCenter, zoom: 18};
  var map1 = new google.maps.Map(mapCanvas, mapOptions);
  var marker1 = new google.maps.Marker({position:myCenter});
  var infowindow = new google.maps.InfoWindow();
  marker1.setMap(map1);
var c = document.getElementById("map1");
var ctx = c.getContext("2d");
var img = document.getElementById("map");
img.onload = function(){
    ctx.drawImage(img,0,0);
}
}
 function procVal(){
	if(document.getElementById("rest1").value.length==0)
	{
	}
	else
	{
		flg='y';
		//alert("Searching DIVE Joints");
		multiArr=[];
		multiArr1=[];
		locArr = document.getElementById("rest1").value;
		locArr = locArr.substring(0, locArr.length - 1);
		locArr=locArr.split('#');
		tmpDat1='';
		for (var i = 0, len = locArr.length; i < len; i++) {
		delimiter = ',';
		start = 7;
		result = locArr[i].split(delimiter, start+1).join(delimiter);
		latR=result.split(',');
		tmpDat1 +="&markers=" +latR[0]+","+latR[1]+","+latR[2];
		
		
		var radlat1 = Math.PI * x/180;
	    var radlat2 = Math.PI * latR[0]/180;
		var theta = y-latR[1];
		var radtheta = Math.PI * theta/180;
		var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
		dist = Math.acos(dist);
	    dist = dist * 180/Math.PI;
		dist = dist * 60 * 1.1515;
	//  alert(dist+"___"+i);
	  //alert(len);
	multiArr.push([latR[2],latR[0],latR[1],dist]);
	multiArr1.push([latR[3],latR[4],latR[5],latR[6],latR[7]]);
		
		}
		document.getElementById("tmpD").value=tmpDat1;
		//navigator.geolocation.getCurrentPosition(handle_geolocation_query);
		displayArr();
		
		
	}	
	
	
}
function displayArr()
{
for (var i = 0, len = multiArr.length; i < len; i++) {
//alert(multiArr[i],multiArr[i],multiArr[i],multiArr[i]);
}
	if(mnu_select==false)
	{
 var map = new google.maps.Map(document.getElementById('map'), {
      zoom: zoom,
      center: new google.maps.LatLng(x,y),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
   var infowindow = new google.maps.InfoWindow();
    var marker, i;
    for (i = 0; i < multiArr.length; i++) { 
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(multiArr[i][1], multiArr[i][2]),
        map: map
      });
      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          infowindow.setContent(multiArr[i][0]);
          infowindow.open(map, marker);
        }
      })(marker, i));
    }
}
	else
	{
		showTbl();
}
	
}
function showTbl()
	{
		lst_mnu.innerHTML=multiArr.length+" Results Found";
	document.getElementById("map").style.display="none";
	document.getElementById("map").style.visibility=false;
	document.getElementById("lst_mnu").style.display="block";
	for (var i = 0, len = multiArr.length; i < len; i++) {
     
	     imgName="http://www.writeacademy.in/dive/images/"+multiArr[i][0].replace(/\s/g, '_')+'.jpg';
		//alert(len+"-"+imgName);
	  //lst_mnu.innerHTML = lst_mnu.innerHTML +"<BR>"+"<input type='text' name='mytext'+ i value='"+aName[0][0]+"'>"
//	  lst_mnu.innerHTML = lst_mnu.innerHTML +"<hr>"+"<img src='"+imgName+"' valign='middle' width='60px' height='60px'>"+"<input type='text' disabled='disabled' style='border:none;' size='12' name='mytext'+ i value='"+ multiArr[i][0]+"'>"+"<input type='text' size=5 style='border:none'  disabled='disabled' name='mytext'+ i value='"+Math.round((parseFloat(multiArr[i][3])*Math.pow(10,2)))/Math.pow(10,2)+"'>"+"<input type='button' style='border:0;background:url(arrow.png);background-repeat: no-repeat;color:white;' value='"+ i+"' onclick='call_hotel(this.value);'>"+"<BR>"
	  
	  lst_mnu.innerHTML=lst_mnu.innerHTML +"<hr>"+"<table width='100%' padding='0' spacing='0'><tr><td><img src='"+imgName+"' valign='middle' width='60px' height='60px'></td><td align='left'>"+multiArr[i][0]+"</td><td align='left'>"+Math.round((parseFloat(multiArr[i][3])*Math.pow(10,2)))/Math.pow(10,2)+"</td><td align='left'><input type='button' style='border:0;background:url(arrow.png);background-repeat: no-repeat;color:white;' value='"+ i+"' onclick='call_hotel(this.value);'>"+"</td></tr>"
	}
		lst_mnu.innerHTML=lst_mnu.innerHTML+"</table>";
	}
	
	function call_hotel(h)
	
	{
		//alert('in');
		fone=parseInt(multiArr1[h][4]);		
		sms.innerHTML="<table width='100%'>";
		//locArr[0] contains full address of a hotel lat,long,hotel name,add1,add2,add3,add4,add5,phone
		imgNam="http://www.writeacademy.in/dive/images/"+multiArr[h][0].replace(/\s/g, '_')+'.jpg';
		document.getElementById("lst_mnu").style.display="none";
		document.getElementById("lst_mnu").style.visibility="false";
		document.getElementById("sms").style.display="block";
		document.getElementById("sms").style.visibility="true";
		
		//sms.innerHTML=multiArr[hNam][0];
		var addr=multiArr1[h][0]+" "+multiArr1[h][1]+" "+multiArr1[h][2]+" "+multiArr1[h][3];

		sms.innerHTML=sms.innerHTML+"<tr><td>"+"<img src='"+imgNam+"' width='40%' height='40%' valign='middle'>"+"</td><td><textarea readonly  style='white-space: pre;overflow-wrap: normal;border: none; outline: none;' cols=40 rows=2>"+addr+"</textarea></td></tr></table>";
		showDiv();
				
				
			
	}
	function showDiv()
	
	{
		//alert('in');
		document.getElementById("inTab").style.display="block";
		document.getElementById("inTab").style.visibility="true";
		//inTab.innerHTML="<table width='100%'>";
		inTab.innerHTML="<table width='100%'><tr><td width='33%'><a 'style=color: black;text-decoration: none;' href=tel:"+fone+">Call</a></td><td width='33%'><a 'style=color: black;text-decoration: none;' href=tel:"+fone+">Call</a></td><td width='33%'><a 'style=color: black;text-decoration: none;' href=tel:"+fone+">Call</a></td></tr></table>"
	//document.write('<a href=tel:"' + fone + '">Call Now</a>');
	}
	
	//showDiv();	
</script>
<style>
	a:hover, a:visited, a:link, a:active
{
    text-decoration: none;
}
	
	
    -webkit-box-shadow: none;
    -moz-box-shadow: none;
    box-shadow: none;
}
	#hr { 
    display: block;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    margin-left: auto;
    margin-right: auto;
    border-style: inset;
    border-width: 1px;
}
	.rock {
    border: none; padding: 0;
    background: 'arrow.png'; 
    background-repeat: no-repeat;
}
	
body, html {
    width: 100%;
    height: 100vh;
    margin: 0;
    padding: 0;
    
}
    #map1 {
    width: 100%;
    height: 65.85%;
    position: fixed;
    display: block;
    z-index: 10;
}
 .hideDontTakeUpSpace
        {
            display:none;
        }
#controls
{
  top: 0;
  left: 0;
  position: absolute;
  
}
	#lst_mnu
	{
		width:100%;
		display:none;
		
	}
	#sms
	{
		display:none;
		
	}
	#inTab
	{
		display:none;
		
	}
.btn1 {  background-color: transparent; border: 0; padding: 0;}
	
</style>
	</head>
<body onload="getLoc();">
	
		<table width="100%" bgcolor="#d78f97">
			<tr><td colspan=2 ><font face=arial>DIVE</font></td></tr>
		<tr><td width="50%" align="center"><input type="button" class='btn1' value="LIST" onclick="ajaxCall('true');" /></td><td width="50%" align="center"><input type="button"  class='btn1'  value="MAP" onclick="ajaxCall('false');" /></td></tr>
	</table>
	
<div id="map" style="position:fixed;width:100%;height:500px">
	<canvas id="map1">   </canvas>
	</div>
	<div id="lst_mnu">
		
	</div>
	<div id="sms">
		
		</div>
	<div id='inTab'>
		
	</div>
	
	
<div id='ajaxDiv' class="hideDontTakeUpSpace">Your result will display here</div>
<textarea id="tmpD"  class="hideDontTakeUpSpace" rows=6 cols=50></textarea>
<textarea id="rest1" class="hideDontTakeUpSpace" rows=6 cols=50></textarea>
</body>
		</html>
